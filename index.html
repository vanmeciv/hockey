<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NHL Rink + Event Logger (0.1s, Possession Change)</title>

<style>
  body { margin:0; background:#0b0f14; color:#e5e7eb; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif; }
  header { padding:12px; border-bottom:1px solid #1f2937; background:#0b0f14; position:sticky; top:0; z-index:5; }
  .row { display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap; }
  .clock { font-size:28px; font-weight:800; letter-spacing:0.5px; }

  .btnRow { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  button { background:#1f2937; color:#e5e7eb; border:0; border-radius:10px; padding:10px 12px; font-weight:700; cursor:pointer; }
  button:active { background:#374151; }

  .teamPill {
    display:inline-flex; gap:8px; align-items:center;
    padding:8px 10px; border:1px solid #1f2937; border-radius:999px;
    background:#0b1220; color:#e5e7eb; font-weight:800; font-size:13px;
    user-select:none;
  }
  .dot { width:10px; height:10px; border-radius:999px; display:inline-block; }
  .dot.home { background:#22c55e; }
  .dot.away { background:#60a5fa; }

  main { padding:12px 12px 220px; }
  #rink { width:100%; height:auto; background:#0b1220; border-radius:18px; border:1px solid #1f2937; touch-action:manipulation; }

  .hint { font-size:12px; color:#9ca3af; margin-top:6px; }
  .events { margin-top:12px; display:flex; flex-direction:column; gap:6px; }
  .event {
    background:#111827; border:1px solid #1f2937; border-radius:10px;
    padding:6px 8px; font-size:14px; display:flex; gap:8px; align-items:center;
  }
  .event strong { width:18px; display:inline-flex; justify-content:center; }
  .event .meta { color:#9ca3af; font-size:12px; margin-left:auto; }
  .pill {
    font-size:11px; padding:2px 8px; border-radius:999px;
    border:1px solid #1f2937; background:#0b1220; color:#e5e7eb; font-weight:800;
  }
  .pill.home { border-color:#16a34a; }
  .pill.away { border-color:#3b82f6; }

  .controls { position:fixed; bottom:0; left:0; right:0; padding:12px; background:#0b0f14; border-top:1px solid #1f2937; z-index:10; }
  .grid { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; }
  .timeGrid { display:grid; grid-template-columns:repeat(6,1fr); gap:8px; margin-top:10px; }
  .timeGrid button { padding:10px 8px; }

  .toast {
    position:fixed; left:12px; right:12px; bottom:235px;
    background:#0b1220; border:1px solid #1f2937; border-radius:12px;
    padding:10px; font-weight:700; display:none; z-index:20;
  }
  .toast.show { display:block; }
</style>
</head>

<body>

<header>
  <div class="row">
    <div class="clock" id="clock">20:00.0</div>
    <div class="btnRow">
      <span class="teamPill" id="teamContextPill" title="Team context for next event (tap to toggle)">
        <span class="dot home" id="teamDot"></span>
        <span id="teamLabel">Team context: HOME</span>
      </span>
      <button id="toggleTeam" title="Toggle team context (Home/Away)">Toggle</button>
      <button id="startStop">Start</button>
      <button id="undo">Undo</button>
      <button id="clearPending">Clear</button>
    </div>
  </div>
</header>

<main>

<!-- NHL regulation rink (200 x 85 feet). Goal dots removed. -->
<svg id="rink" viewBox="0 0 200 85" preserveAspectRatio="xMidYMid meet" aria-label="NHL regulation rink (feet)">
  <rect x="0" y="0" width="200" height="85" rx="28" ry="28"
        fill="none" stroke="#e5e7eb" stroke-width="0.8"/>

  <rect x="10.9167" y="0" width="0.1667" height="85" fill="#ef4444"/>
  <rect x="188.9167" y="0" width="0.1667" height="85" fill="#ef4444"/>

  <rect x="74.5"  y="0" width="1" height="85" fill="#3b82f6"/>
  <rect x="124.5" y="0" width="1" height="85" fill="#3b82f6"/>

  <rect x="99.5" y="0" width="1" height="85" fill="#ef4444"/>

  <circle cx="100" cy="42.5" r="15" fill="none" stroke="#3b82f6" stroke-width="0.1667"/>
  <circle cx="100" cy="42.5" r="0.5" fill="#3b82f6"/>

  <g fill="none" stroke="#ef4444" stroke-width="0.1667">
    <circle cx="80"  cy="20.5" r="1"/><circle cx="80"  cy="64.5" r="1"/>
    <circle cx="120" cy="20.5" r="1"/><circle cx="120" cy="64.5" r="1"/>
  </g>

  <g fill="none" stroke="#ef4444" stroke-width="0.1667">
    <circle cx="31"  cy="20.5" r="15"/><circle cx="31"  cy="64.5" r="15"/>
    <circle cx="169" cy="20.5" r="15"/><circle cx="169" cy="64.5" r="15"/>
  </g>

  <g fill="#ef4444">
    <circle cx="31"  cy="20.5" r="1"/><circle cx="31"  cy="64.5" r="1"/>
    <circle cx="169" cy="20.5" r="1"/><circle cx="169" cy="64.5" r="1"/>
  </g>

  <path d="M 11 38.5 L 15.5 38.5 A 6 6 0 0 1 15.5 46.5 L 11 46.5"
        fill="none" stroke="#ef4444" stroke-width="0.1667"/>
  <path d="M 189 38.5 L 184.5 38.5 A 6 6 0 0 0 184.5 46.5 L 189 46.5"
        fill="none" stroke="#ef4444" stroke-width="0.1667"/>

  <!-- Possession-change geometry (behind symbols) -->
  <g id="possessionChangeLines"></g>

  <!-- Event markers -->
  <g id="markers"></g>
</svg>

<div class="hint" id="hint">Tap an event, then tap the rink to place it (optional). Possession Change requires 2 taps (loss → gain).</div>
<div class="events" id="events"></div>

</main>

<div class="toast" id="toast"></div>

<div class="controls">
  <div class="grid">
    <button data-type="goal">GOAL</button>
    <button data-type="shot">SHOT</button>
    <button data-type="hit">HIT</button>
    <button data-type="penalty">PENALTY</button>
    <button data-type="pos_change">POSSESSION CHANGE</button>
    <button data-type="note">NOTE</button>
  </div>

  <div class="timeGrid">
    <button data-dt="-600">-60s</button>
    <button data-dt="-100">-10s</button>
    <button data-dt="-10">-1s</button>
    <button data-dt="10">+1s</button>
    <button data-dt="100">+10s</button>
    <button data-dt="600">+60s</button>

    <button data-dt="-1">-0.1s</button>
    <button data-dt="1">+0.1s</button>
    <button id="set2000">Set 20:00.0</button>
    <button id="set1500">Set 15:00.0</button>
    <button id="set0500">Set 05:00.0</button>
    <button id="stop">Stop</button>
  </div>
</div>

<script>
const SYMBOL = {
  goal:"●",
  shot:"△",
  hit:"✖",
  penalty:"▢",
  pos_change:"⇄", // rendered twice (loss + gain)
  note:"✎"
};

const TEAM_COLOR = { home:"#22c55e", away:"#60a5fa" };

const state = {
  clockTenths: 20 * 60 * 10,
  running: false,
  events: [],
  // pending placement: { event, stage } where stage is "single" or "loss"/"gain"
  pending: null,
  teamContext: "home" // team assigned to newly logged events (and LOSS side of possession change)
};

const rink = document.getElementById("rink");
const markers = document.getElementById("markers");
const pcLines = document.getElementById("possessionChangeLines");
const eventsEl = document.getElementById("events");
const toast = document.getElementById("toast");
const hint = document.getElementById("hint");

const teamDot = document.getElementById("teamDot");
const teamLabel = document.getElementById("teamLabel");
const teamContextPill = document.getElementById("teamContextPill");

function formatTime(tenths) {
  const totalSeconds = Math.floor(tenths / 10);
  const t = tenths % 10;
  const m = Math.floor(totalSeconds / 60);
  const s = totalSeconds % 60;
  return `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}.${t}`;
}

let toastTimer = null;
function showToast(msg) {
  toast.textContent = msg;
  toast.classList.add("show");
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => toast.classList.remove("show"), 1800);
}

function updateTeamUI() {
  const team = state.teamContext;
  teamDot.classList.toggle("home", team === "home");
  teamDot.classList.toggle("away", team === "away");
  teamLabel.textContent = `Team context: ${team.toUpperCase()}`;
}

function toggleTeamContext(show=true) {
  state.teamContext = (state.teamContext === "home") ? "away" : "home";
  updateTeamUI();
  if (show) showToast(`Team context: ${state.teamContext.toUpperCase()}`);
}

function otherTeam(team) { return team === "home" ? "away" : "home"; }

function svgPointFromClick(evt) {
  const r = rink.getBoundingClientRect();
  return {
    x: (evt.clientX - r.left) / r.width * 200,
    y: (evt.clientY - r.top) / r.height * 85
  };
}

/* ===== rendering ===== */
function render() {
  document.getElementById("clock").textContent = formatTime(state.clockTenths);

  // timeline
  eventsEl.innerHTML = state.events.map(e => {
    if (e.type === "pos_change") {
      const lossColor = TEAM_COLOR[e.lossTeam];
      const gainColor = TEAM_COLOR[e.gainTeam];
      const placed = (e.lossXY && e.gainXY) ? "placed" : "unplaced";
      return `<div class="event">
        <strong style="color:${lossColor}">⇄</strong>
        <span>POS CHANGE @ ${formatTime(e.time)}</span>
        <span class="pill ${e.lossTeam}">${e.lossTeam.toUpperCase()} LOSS</span>
        <span class="pill ${e.gainTeam}">${e.gainTeam.toUpperCase()} GAIN</span>
        <span class="meta">${placed}</span>
      </div>`;
    } else {
      const sym = SYMBOL[e.type] ?? "?";
      const symColor = TEAM_COLOR[e.team] ?? "#e5e7eb";
      const placed = e.xy ? "placed" : "unplaced";
      return `<div class="event">
        <strong style="color:${symColor}">${sym}</strong>
        <span>${e.type.toUpperCase()} @ ${formatTime(e.time)}</span>
        <span class="pill ${e.team}">${e.team.toUpperCase()}</span>
        <span class="meta">${placed}</span>
      </div>`;
    }
  }).join("");

  // possession-change geometry (lines)
  pcLines.innerHTML = "";
  const chronological = [...state.events].reverse();
  for (const e of chronological) {
    if (e.type !== "pos_change") continue;
    if (!e.lossXY || !e.gainXY) continue;

    // split line at midpoint: lossTeam color then gainTeam color
    const mid = { x:(e.lossXY.x + e.gainXY.x)/2, y:(e.lossXY.y + e.gainXY.y)/2 };

    const l1 = document.createElementNS("http://www.w3.org/2000/svg","line");
    l1.setAttribute("x1", e.lossXY.x); l1.setAttribute("y1", e.lossXY.y);
    l1.setAttribute("x2", mid.x);      l1.setAttribute("y2", mid.y);
    l1.setAttribute("stroke", TEAM_COLOR[e.lossTeam]);
    l1.setAttribute("stroke-width", "0.9");
    l1.setAttribute("opacity", "0.85");
    l1.setAttribute("stroke-linecap", "round");

    const l2 = document.createElementNS("http://www.w3.org/2000/svg","line");
    l2.setAttribute("x1", mid.x);      l2.setAttribute("y1", mid.y);
    l2.setAttribute("x2", e.gainXY.x); l2.setAttribute("y2", e.gainXY.y);
    l2.setAttribute("stroke", TEAM_COLOR[e.gainTeam]);
    l2.setAttribute("stroke-width", "0.9");
    l2.setAttribute("opacity", "0.85");
    l2.setAttribute("stroke-linecap", "round");

    pcLines.appendChild(l1);
    pcLines.appendChild(l2);
  }

  // markers (symbols)
  markers.innerHTML = "";
  for (const e of chronological) {
    if (e.type === "pos_change") {
      // draw loss symbol + gain symbol
      if (e.lossXY) {
        const t = document.createElementNS("http://www.w3.org/2000/svg","text");
        t.setAttribute("x", e.lossXY.x); t.setAttribute("y", e.lossXY.y);
        t.setAttribute("font-size","4");
        t.setAttribute("text-anchor","middle");
        t.setAttribute("dominant-baseline","middle");
        t.setAttribute("fill", TEAM_COLOR[e.lossTeam]);
        t.textContent = "⇄";
        markers.appendChild(t);
      }
      if (e.gainXY) {
        const t = document.createElementNS("http://www.w3.org/2000/svg","text");
        t.setAttribute("x", e.gainXY.x); t.setAttribute("y", e.gainXY.y);
        t.setAttribute("font-size","4");
        t.setAttribute("text-anchor","middle");
        t.setAttribute("dominant-baseline","middle");
        t.setAttribute("fill", TEAM_COLOR[e.gainTeam]);
        t.textContent = "⇄";
        markers.appendChild(t);
      }
    } else {
      if (!e.xy) continue;
      const t = document.createElementNS("http://www.w3.org/2000/svg","text");
      t.setAttribute("x", e.xy.x); t.setAttribute("y", e.xy.y);
      t.setAttribute("font-size","4");
      t.setAttribute("text-anchor","middle");
      t.setAttribute("dominant-baseline","middle");
      t.setAttribute("fill", TEAM_COLOR[e.team] ?? "#e5e7eb");
      t.textContent = SYMBOL[e.type] ?? "?";
      markers.appendChild(t);
    }
  }
}

/* ===== log buttons ===== */
document.querySelectorAll(".grid button").forEach(btn => {
  btn.addEventListener("click", () => {
    const type = btn.dataset.type;

    if (type === "pos_change") {
      const lossTeam = state.teamContext;
      const gainTeam = otherTeam(lossTeam);

      const ev = {
        type:"pos_change",
        time: state.clockTenths,
        lossTeam, gainTeam,
        lossXY: null,
        gainXY: null
      };

      state.events.unshift(ev);
      state.pending = { event: ev, stage: "loss" };
      hint.textContent = "POS CHANGE: tap LOSS location (where old team loses puck).";
      showToast(`POS CHANGE (${lossTeam.toUpperCase()} → ${gainTeam.toUpperCase()}): place LOSS`);
      render();
      return;
    }

    // normal (single-point) event
    const ev = { type, time: state.clockTenths, team: state.teamContext, xy: null };
    state.events.unshift(ev);
    state.pending = { event: ev, stage: "single" };
    hint.textContent = "Tap the rink to place that event (optional).";
    showToast(`${SYMBOL[type] ?? "?"} ${type.toUpperCase()} (${state.teamContext.toUpperCase()}) logged`);
    render();
  });
});

/* ===== rink click placement ===== */
rink.addEventListener("click", (e) => {
  if (!state.pending) {
    showToast("No pending event to place");
    return;
  }

  const pt = svgPointFromClick(e);
  const ev = state.pending.event;

  if (state.pending.stage === "single") {
    ev.xy = pt;
    state.pending = null;
    hint.textContent = "Tap an event, then tap the rink to place it (optional).";
    showToast("Placed");
    render();
    return;
  }

  if (ev.type === "pos_change") {
    if (state.pending.stage === "loss") {
      ev.lossXY = pt;
      state.pending.stage = "gain";
      hint.textContent = "POS CHANGE: tap GAIN location (where new team controls puck).";
      showToast("Now place GAIN");
      render();
      return;
    }
    if (state.pending.stage === "gain") {
      ev.gainXY = pt;
      state.pending = null;

      // After a possession change completes, the new team becomes the context for subsequent events.
      state.teamContext = ev.gainTeam;
      updateTeamUI();

      hint.textContent = "Tap an event, then tap the rink to place it (optional).";
      showToast(`Possession now: ${ev.gainTeam.toUpperCase()}`);
      render();
      return;
    }
  }
});

/* ===== top controls ===== */
document.getElementById("toggleTeam").addEventListener("click", () => toggleTeamContext(true));
teamContextPill.addEventListener("click", () => toggleTeamContext(true));

document.getElementById("startStop").addEventListener("click", () => {
  state.running = !state.running;
  document.getElementById("startStop").textContent = state.running ? "Pause" : "Start";
  showToast(state.running ? "Running" : "Paused");
});

document.getElementById("stop").addEventListener("click", () => {
  state.running = false;
  document.getElementById("startStop").textContent = "Start";
  showToast("Stopped");
});

document.getElementById("undo").addEventListener("click", () => {
  const removed = state.events.shift();
  if (state.pending && state.pending.event === removed) state.pending = null;
  showToast("Undo");
  render();
});

document.getElementById("clearPending").addEventListener("click", () => {
  state.pending = null;
  hint.textContent = "Tap an event, then tap the rink to place it (optional). Possession Change requires 2 taps (loss → gain).";
  showToast("Cleared");
  render();
});

/* ===== time adjust ===== */
document.querySelectorAll(".timeGrid button[data-dt]").forEach(btn => {
  btn.addEventListener("click", () => {
    state.clockTenths = Math.max(0, state.clockTenths + Number(btn.dataset.dt));
    render();
  });
});
document.getElementById("set2000").addEventListener("click", () => { state.clockTenths = 20*60*10; render(); });
document.getElementById("set1500").addEventListener("click", () => { state.clockTenths = 15*60*10; render(); });
document.getElementById("set0500").addEventListener("click", () => { state.clockTenths =  5*60*10; render(); });

/* ===== tick every 0.1s ===== */
setInterval(() => {
  if (state.running && state.clockTenths > 0) {
    state.clockTenths--;
    render();
  }
}, 100);

/* init */
updateTeamUI();
render();
</script>

</body>
</html>
