<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>NHL Regulation Rink + Event Logger (0.1s, Auto Possession Team)</title>

<style>
  body { margin:0; background:#0b0f14; color:#e5e7eb; font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif; }
  header { padding:12px; border-bottom:1px solid #1f2937; background:#0b0f14; position:sticky; top:0; z-index:5; }
  .row { display:flex; justify-content:space-between; align-items:center; gap:8px; flex-wrap:wrap; }
  .clock { font-size:28px; font-weight:800; letter-spacing:0.5px; }

  .btnRow { display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
  button { background:#1f2937; color:#e5e7eb; border:0; border-radius:10px; padding:10px 12px; font-weight:700; cursor:pointer; }
  button:active { background:#374151; }

  .teamPill {
    display:inline-flex; gap:8px; align-items:center;
    padding:8px 10px; border:1px solid #1f2937; border-radius:999px;
    background:#0b1220; color:#e5e7eb; font-weight:800; font-size:13px;
    user-select:none;
  }
  .dot { width:10px; height:10px; border-radius:999px; display:inline-block; }
  .dot.home { background:#22c55e; }
  .dot.away { background:#60a5fa; }

  main { padding:12px 12px 220px; }
  #rink { width:100%; height:auto; background:#0b1220; border-radius:18px; border:1px solid #1f2937; touch-action:manipulation; }

  .hint { font-size:12px; color:#9ca3af; margin-top:6px; }
  .events { margin-top:12px; display:flex; flex-direction:column; gap:6px; }
  .event {
    background:#111827; border:1px solid #1f2937; border-radius:10px;
    padding:6px 8px; font-size:14px; display:flex; gap:8px; align-items:center;
  }
  .event strong { width:18px; display:inline-flex; justify-content:center; }
  .event .meta { color:#9ca3af; font-size:12px; margin-left:auto; }
  .pill {
    font-size:11px; padding:2px 8px; border-radius:999px;
    border:1px solid #1f2937; background:#0b1220; color:#e5e7eb; font-weight:800;
  }
  .pill.home { border-color:#16a34a; }
  .pill.away { border-color:#3b82f6; }

  .controls { position:fixed; bottom:0; left:0; right:0; padding:12px; background:#0b0f14; border-top:1px solid #1f2937; z-index:10; }
  .grid { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; }
  .timeGrid { display:grid; grid-template-columns:repeat(6,1fr); gap:8px; margin-top:10px; }
  .timeGrid button { padding:10px 8px; }

  .toast {
    position:fixed; left:12px; right:12px; bottom:235px;
    background:#0b1220; border:1px solid #1f2937; border-radius:12px;
    padding:10px; font-weight:700; display:none; z-index:20;
  }
  .toast.show { display:block; }
</style>
</head>

<body>

<header>
  <div class="row">
    <div class="clock" id="clock">20:00.0</div>
    <div class="btnRow">
      <span class="teamPill" id="possTeamPill" title="Next POSSESSION owner (tap to toggle)">
        <span class="dot home" id="possDot"></span>
        <span id="possLabel">Next possession: HOME</span>
      </span>
      <button id="toggleTeam" title="Toggle next POSSESSION owner">Toggle</button>
      <button id="startStop">Start</button>
      <button id="undo">Undo</button>
      <button id="clearPending">Clear “place”</button>
    </div>
  </div>
</header>

<main>

<svg id="rink" viewBox="0 0 200 85" preserveAspectRatio="xMidYMid meet" aria-label="NHL regulation rink (feet)">
  <rect x="0" y="0" width="200" height="85" rx="28" ry="28"
        fill="none" stroke="#e5e7eb" stroke-width="0.8"/>

  <rect x="10.9167" y="0" width="0.1667" height="85" fill="#ef4444"/>
  <rect x="188.9167" y="0" width="0.1667" height="85" fill="#ef4444"/>

  <rect x="74.5"  y="0" width="1" height="85" fill="#3b82f6"/>
  <rect x="124.5" y="0" width="1" height="85" fill="#3b82f6"/>

  <rect x="99.5" y="0" width="1" height="85" fill="#ef4444"/>

  <circle cx="100" cy="42.5" r="15" fill="none" stroke="#3b82f6" stroke-width="0.1667"/>
  <circle cx="100" cy="42.5" r="0.5" fill="#3b82f6"/>

  <g fill="none" stroke="#ef4444" stroke-width="0.1667">
    <circle cx="80"  cy="20.5" r="1"/><circle cx="80"  cy="64.5" r="1"/>
    <circle cx="120" cy="20.5" r="1"/><circle cx="120" cy="64.5" r="1"/>
  </g>

  <g fill="none" stroke="#ef4444" stroke-width="0.1667">
    <circle cx="31"  cy="20.5" r="15"/><circle cx="31"  cy="64.5" r="15"/>
    <circle cx="169" cy="20.5" r="15"/><circle cx="169" cy="64.5" r="15"/>
  </g>

  <g fill="#ef4444">
    <circle cx="31"  cy="20.5" r="1"/><circle cx="31"  cy="64.5" r="1"/>
    <circle cx="169" cy="20.5" r="1"/><circle cx="169" cy="64.5" r="1"/>
  </g>

  <path d="M 11 38.5 L 15.5 38.5 A 6 6 0 0 1 15.5 46.5 L 11 46.5"
        fill="none" stroke="#ef4444" stroke-width="0.1667"/>
  <path d="M 189 38.5 L 184.5 38.5 A 6 6 0 0 0 184.5 46.5 L 189 46.5"
        fill="none" stroke="#ef4444" stroke-width="0.1667"/>

  <g id="possessionLines"></g>
  <g id="markers"></g>
</svg>

<div class="hint" id="hint">Tap an event button, then tap the rink to place it (optional).</div>
<div class="events" id="events"></div>

</main>

<div class="toast" id="toast"></div>

<div class="controls">
  <div class="grid">
    <button data-type="goal">GOAL</button>
    <button data-type="shot">SHOT</button>
    <button data-type="hit">HIT</button>
    <button data-type="penalty">PENALTY</button>
    <button data-type="possession">POSSESSION</button>
    <button data-type="note">NOTE</button>
  </div>

  <div class="timeGrid">
    <button data-dt="-600">-60s</button>
    <button data-dt="-100">-10s</button>
    <button data-dt="-10">-1s</button>
    <button data-dt="10">+1s</button>
    <button data-dt="100">+10s</button>
    <button data-dt="600">+60s</button>

    <button data-dt="-1">-0.1s</button>
    <button data-dt="1">+0.1s</button>
    <button id="set2000">Set 20:00.0</button>
    <button id="set1500">Set 15:00.0</button>
    <button id="set0500">Set 05:00.0</button>
    <button id="stop">Stop</button>
  </div>
</div>

<script>
const SYMBOL = { goal:"●", shot:"△", hit:"✖", penalty:"▢", possession:"⇄", note:"✎" };
const TEAM_COLOR = { home:"#22c55e", away:"#60a5fa" };

const state = {
  clockTenths: 20 * 60 * 10,
  running: false,
  events: [],
  pendingEvent: null,
  possessionTeam: "home" // "next possession owner"
};

const rink = document.getElementById("rink");
const markers = document.getElementById("markers");
const possessionLines = document.getElementById("possessionLines");
const eventsEl = document.getElementById("events");
const toast = document.getElementById("toast");
const hint = document.getElementById("hint");

const possDot = document.getElementById("possDot");
const possLabel = document.getElementById("possLabel");
const possTeamPill = document.getElementById("possTeamPill");

function formatTime(tenths) {
  const totalSeconds = Math.floor(tenths / 10);
  const t = tenths % 10;
  const m = Math.floor(totalSeconds / 60);
  const s = totalSeconds % 60;
  return `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}.${t}`;
}

let toastTimer = null;
function showToast(msg) {
  toast.textContent = msg;
  toast.classList.add("show");
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => toast.classList.remove("show"), 1800);
}

function updatePossessionUI() {
  const team = state.possessionTeam;
  possDot.classList.toggle("home", team === "home");
  possDot.classList.toggle("away", team === "away");
  possLabel.textContent = `Next possession: ${team.toUpperCase()}`;
}

function togglePossessionTeam(show=true) {
  state.possessionTeam = (state.possessionTeam === "home") ? "away" : "home";
  updatePossessionUI();
  if (show) showToast(`Next possession: ${state.possessionTeam.toUpperCase()}`);
}

function render() {
  document.getElementById("clock").textContent = formatTime(state.clockTenths);

  eventsEl.innerHTML = state.events.map((e) => {
    const sym = SYMBOL[e.type] ?? "?";
    const placed = e.xy ? "placed" : "unplaced";
    const teamPill = e.type === "possession" ? `<span class="pill ${e.team}">${e.team.toUpperCase()}</span>` : "";
    const symColor = (e.type === "possession") ? (TEAM_COLOR[e.team] ?? "#e5e7eb") : "#e5e7eb";
    return `<div class="event">
      <strong style="color:${symColor}">${sym}</strong>
      <span>${e.type.toUpperCase()} @ ${formatTime(e.time)}</span>
      ${teamPill}
      <span class="meta">${placed}</span>
    </div>`;
  }).join("");

  // possession path lines
  possessionLines.innerHTML = "";
  const chronological = [...state.events].reverse();
  const possPlaced = chronological.filter(ev => ev.type === "possession" && ev.xy);

  for (let i = 1; i < possPlaced.length; i++) {
    const a = possPlaced[i - 1];
    const b = possPlaced[i];
    const segColor = TEAM_COLOR[a.team] ?? "#e5e7eb";

    const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
    line.setAttribute("x1", a.xy.x);
    line.setAttribute("y1", a.xy.y);
    line.setAttribute("x2", b.xy.x);
    line.setAttribute("y2", b.xy.y);
    line.setAttribute("stroke", segColor);
    line.setAttribute("stroke-width", "0.8");
    line.setAttribute("opacity", "0.80");
    line.setAttribute("stroke-linecap", "round");
    possessionLines.appendChild(line);
  }

  // markers
  markers.innerHTML = "";
  const ordered = [...state.events].reverse();
  for (const e of ordered) {
    if (!e.xy) continue;

    const t = document.createElementNS("http://www.w3.org/2000/svg", "text");
    t.setAttribute("x", e.xy.x);
    t.setAttribute("y", e.xy.y);
    t.setAttribute("font-size", "4");
    t.setAttribute("text-anchor", "middle");
    t.setAttribute("dominant-baseline", "middle");
    t.textContent = SYMBOL[e.type] ?? "?";

    const fill = (e.type === "possession") ? (TEAM_COLOR[e.team] ?? "#e5e7eb") : "#e5e7eb";
    t.setAttribute("fill", fill);
    markers.appendChild(t);
  }
}

/* ===== Log event ===== */
document.querySelectorAll(".grid button").forEach(btn => {
  btn.addEventListener("click", () => {
    const type = btn.dataset.type;

    // capture the team at LOG TIME (not later)
    const teamAtLog = (type === "possession") ? state.possessionTeam : null;

    const evt = { type, time: state.clockTenths, xy: null, team: teamAtLog };
    state.events.unshift(evt);
    state.pendingEvent = evt;

    hint.textContent = "Now tap the rink to place that event (optional).";

    if (type === "possession") {
      showToast(`${SYMBOL[type]} POSSESSION (${teamAtLog.toUpperCase()}) logged`);
      // IMPORTANT: auto-advance to the OTHER team for the next possession press
      togglePossessionTeam(false);
    } else {
      showToast(`${SYMBOL[type]} ${type.toUpperCase()} logged`);
    }

    render();
  });
});

/* ===== Place event on rink ===== */
rink.addEventListener("click", (e) => {
  if (!state.pendingEvent) {
    showToast("No pending event to place");
    return;
  }

  const r = rink.getBoundingClientRect();
  const x = (e.clientX - r.left) / r.width * 200;
  const y = (e.clientY - r.top) / r.height * 85;

  state.pendingEvent.xy = { x, y };
  state.pendingEvent = null;

  hint.textContent = "Tap an event button, then tap the rink to place it (optional).";
  showToast("Placed");
  render();
});

/* ===== Possession team toggle (manual correction) ===== */
document.getElementById("toggleTeam").addEventListener("click", () => togglePossessionTeam(true));
possTeamPill.addEventListener("click", () => togglePossessionTeam(true));

/* ===== Clock controls ===== */
document.getElementById("startStop").addEventListener("click", () => {
  state.running = !state.running;
  document.getElementById("startStop").textContent = state.running ? "Pause" : "Start";
  showToast(state.running ? "Running" : "Paused");
});

document.getElementById("stop").addEventListener("click", () => {
  state.running = false;
  document.getElementById("startStop").textContent = "Start";
  showToast("Stopped");
});

document.getElementById("undo").addEventListener("click", () => {
  const removed = state.events.shift();
  if (state.pendingEvent === removed) state.pendingEvent = null;
  showToast("Undo");
  render();
});

document.getElementById("clearPending").addEventListener("click", () => {
  state.pendingEvent = null;
  hint.textContent = "Tap an event button, then tap the rink to place it (optional).";
  showToast("Cleared pending placement");
  render();
});

/* ===== Time adjust ===== */
document.querySelectorAll(".timeGrid button[data-dt]").forEach(btn => {
  btn.addEventListener("click", () => {
    state.clockTenths = Math.max(0, state.clockTenths + Number(btn.dataset.dt));
    render();
  });
});

document.getElementById("set2000").addEventListener("click", () => { state.clockTenths = 20*60*10; render(); });
document.getElementById("set1500").addEventListener("click", () => { state.clockTenths = 15*60*10; render(); });
document.getElementById("set0500").addEventListener("click", () => { state.clockTenths =  5*60*10; render(); });

/* ===== Tick every 0.1s ===== */
setInterval(() => {
  if (state.running && state.clockTenths > 0) {
    state.clockTenths--;
    render();
  }
}, 100);

/* init */
updatePossessionUI();
render();
</script>

</body>
</html>
